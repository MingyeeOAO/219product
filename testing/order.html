<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
    <script crossorigin="anonymous" src="https://kit.fontawesome.com/3c5be74ba6.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <link href="https://unpkg.com/aos@next/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <title>訂單表單</title>
    <link href="order.css" rel="stylesheet">
    <script src="order.js" ></script>
    <script>
        function overlay(boo){
            const overlay = document.getElementById('overlay');
            const mainContent = document.body;
            if(boo) {
                overlay.style.display = 'block';
                mainContent.style.pointerEvents = 'none';
                mainContent.style.overflow = 'hidden';
            }
            else{
                overlay.style.display = 'none';
                mainContent.style.pointerEvents = 'auto';
                mainContent.style.overflow = 'auto';
            }
        }
        
        
        function error(msg){
            overlay(false);
            Swal.fire({
                icon: 'error',
                title: '訂餐失敗!',
                text: msg,
                footer: '219預購系統'
            }); 
        }
        function checkAllZero() {
            var numberInputs = document.querySelectorAll('input[type="number"]');
            var res = true;
            numberInputs.forEach(input => {
                if (parseInt(input.value) !== 0) {
                    alert((input.id));
                    return res = false;
                }
            })
            
        
            return res;
        }
        function submitOrder() {
            overlay(true);
            var form = document.getElementById("orderForm");
            var formData = new FormData(form);
            var stop = false;
            //check sets ammount
            const s= ['a', 'b', 'c'];
            s.forEach((element) => {
                var tmp = element;
                element = 's'+element;
                var sets = parseInt(document.getElementById(element).value);
                var c = parseInt(document.getElementById(element+"cola").value);
                var g = parseInt(document.getElementById(element+"green").value);
                var l = parseInt(document.getElementById(element+"lemon").value);
                var s = parseInt(document.getElementById(element+"sp").value);
                var tt = sets;
                if(element != 'sa'){
                    tt = parseInt(document.getElementById(element+"bul").value) + parseInt(document.getElementById(element+"tls").value);
                }
                if (sets != c+g+l+s || sets != tt) {
                    stop = true;
                    return error("套餐"+tmp+"內容選擇錯誤");
                }
            })
            name = document.getElementById("name").value;
            phone = document.getElementById("phone").value;
            time = document.getElementById("time").value;
            if(name == '') return error("請填寫姓名");
            if(phone == '') return error("請填寫電話");
            if(time == '') return error("請填寫取餐時間");

            if(stop) return overlay(false);

            var timeInput = document.getElementById("time").value;
            var selectedTime = new Date("2000-01-01 " + timeInput); 
            const minTime = new Date("2000-01-01 9:30"); 
            const maxTime = new Date("2000-01-01 12:00");

            if (selectedTime < minTime || selectedTime > maxTime) {
                return error("Please select a time between 9:30 AM and 12:00 AM.");
            }
            if (checkAllZero()) return error("請勿送出空訂單!")
            
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "save_order.php", true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var response = xhr.responseText;
                    if(response == 'failed') return error("可能是伺服器忙線中或是您在短時間內送出過多訂單，請稍後約30秒後再次嘗試");
                    Swal.fire({
                        icon: 'success',
                        title: '已送出訂單!',
                        //text: '你的單號:'+ response+'\n請稍等約5秒鐘等待qr code出現後截圖\n當天出示給工作人員即可!',
                        footer: '記得截圖留存',
                        html: '<img src=\'https://api.qrserver.com/v1/create-qr-code/?data=' + response + '&amp;size=150x150\'>  </img> <br> 你的單號:' + response+'<br>請稍等約5秒鐘等待qr code出現後截圖<br>當天出示給工作人員即可!'
                    }); 
                    overlay(false)
                    return document.getElementById("orderForm").reset();
                }
                else{
                    //return error("伺服器無回應")
                }
            };
            xhr.send(formData);
        }
        function inc(name, dif){    
            var obj = document.getElementById(name);
            var tmp = parseInt(obj.value) + dif;
            if(tmp > parseInt(obj.max) || tmp < parseInt(obj.min)) return;
            return    obj.value = tmp;
        }
    </script>
</head>
<div id="overlay">
    <div class="loader" > </div>
</div>

<body>

<h2>ORDER</h2>

<form id="orderForm">
    <label for="name">姓名：</label><br>
    <input type="text" id="name" name="name" required><br><br>
    
    <label for="phone">電話：</label><br>
    <input type="text" id="phone" name="phone" required><br><br>
    
    <label for="time">時間：</label><br>
    <input type="time" id="time" name="time" min="09:30" max="12:00" required><br><br>

    
    單點:<br><br>
    <label for="sandwich">三明治：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sandwich', 1)">
    <input type="number" class = "holder" id="sandwich" name="sandwich" value="0" min="0" max="10" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sandwich', -1)"><br><br>

    <label for="cola">可樂：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('cola', 1)">
    <input type="number" class = "holder" id="cola" name="cola" value="0" min="0" max="10" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('cola', -1)"><br><br>
    
    <label for="green">多多綠：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('green', 1)">
    <input type="number" class = "holder" id="green" name="green" value="0" min="0" max="10" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('green', -1)"><br><br>
    
    <label for="lemon">冬瓜檸：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('lemon', 1)">
    <input type="number" class = "holder" id="lemon" name="lemon" value="0" min="0" max="10" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('lemon', -1)"><br><br>

    <label for="sp">雪碧：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sp', 1)">
    <input type="number" class = "holder" id="sp" name="sp" value="0" min="0" max="10" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sp', -1)"><br><br>

    <label for="tls">銅鑼燒：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('tls', 1)">
    <input type="number" class = "holder" id="tls" name="tls" value="0" min="0" max="10" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('tls', -1)"><br><br>
    
    <label for="bul">布蕾：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('bul', 1)">
    <input type="number" class = "holder" id="bul" name="bul" value="0" min="0" max="10" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('bul', -1)"><br><br>


    <label for="sa">套餐 A：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sa', 1)">
    <input type="number" class = "holder" id="sa" name="sa" value="0" min="0" max="5" readonly>
    <input type="button" value="-" class="ch" onclick="inc('sa', -1)"><br><br>

    <label for="sacola">可樂：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sacola', 1)">
    <input type="number" class = "holder" id="sacola" name="sacola" value="0" min="0" max="5" readonly>
    <input type="button" value="-" class="ch" onclick="inc('sacola', -1)"><br>

    <label for="sagreen">多多綠：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sagreen', 1)">
    <input type="number" class = "holder" id="sagreen" name="sagreen" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sagreen', -1)"><br>

    <label for="sasp">雪碧：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sasp', 1)">
    <input type="number" class = "holder" id="sasp" name="sasp" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sasp', -1)"><br>

    <label for="salemon">冬瓜檸：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('salemon', 1)">
    <input type="number" class = "holder" id="salemon" name="salemon" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('salemon', -1)"><br><br>
    
    <label for="sb">套餐 B：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sb', 1)">
    <input type="number" class = "holder" id="sb" name="sb" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sb', -1)"><br><br>

    <label for="sbcola">可樂：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sbcola', 1)">
    <input type="number" class = "holder" id="sbcola" name="sbcola" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sbcola', -1)"><br>
    
    <label for="sbgreen">多多綠：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sbgreen', 1)">
    <input type="number" class = "holder" id="sbgreen" name="sbgreen" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sbgreen', -1)"><br>

    <label for="sbsp">雪碧：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sbsp', 1)">
    <input type="number" class = "holder" id="sbsp" name="sbsp" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sbsp', -1)"><br>
    
    <label for="sblemon">冬瓜檸：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sblemon', 1)">
    <input type="number" class = "holder" id="sblemon" name="sblemon" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sblemon', -1)"><br><br>
    
    <label for="sbtls">銅鑼燒x2：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sbtls', 1)">
    <input type="number" class = "holder" id="sbtls" name="sbtls" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sbtls', -1)"><br>
    
    <label for="sbbul">布蕾：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sbbul', 1)">
    <input type="number" class = "holder" id="sbbul" name="sbbul" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sbbul', -1)"><br><br>

    <label for="sc">套餐 C：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sc', 1)">
    <input type="number" class = "holder" id="sc" name="sc" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sc', -1)"><br><br>
    
    <label for="sccola">可樂：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sccola', 1)">
    <input type="number" class = "holder" id="sccola" name="sccola" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sccola', -1)"><br>
    
    <label for="scgreen">多多綠：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('scgreen', 1)">
    <input type="number" class = "holder" id="scgreen" name="scgreen" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('scgreen', -1)"><br>

    <label for="scsp">雪碧：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('scsp', 1)">
    <input type="number" class = "holder" id="scsp" name="scsp" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('scsp', -1)"><br>
    
    <label for="sclemon">冬瓜檸：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sclemon', 1)">
    <input type="number" class = "holder" id="sclemon" name="sclemon" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sclemon', -1)"><br><br>
    
    <label for="sctls">銅鑼燒x2：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('sctls', 1)">
    <input type="number" class = "holder" id="sctls" name="sctls" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('sctls', -1)"><br>
    
    <label for="scbul">布蕾：</label><br>
    <input type="button" value="+" class="ch" onclick="inc('scbul', 1)">
    <input type="number" class = "holder" id="scbul" name="scbul" value="0" min="0" max="5" readonly required>
    <input type="button" value="-" class="ch" onclick="inc('scbul', -1)"><br><br>


    <input type="button" value="下訂單" onclick="submitOrder()">
</form>

<div id="orderResult"></div>

</body>
</html>
